{{- define "patch" }}
spec:
  template:
    spec:
      containers:
        {{- .container | list | toYaml | nindent 8 }}
      {{- with .Values.skeOperator.nodeSelector }}
      nodeSelector:
        {{- . | toYaml | nindent 8 }}
      {{- end }}
      {{- with .Values.skeOperator.tolerations }}
      tolerations:
        {{- . | toYaml | nindent 8 }}
      {{- end }}
      {{- with .Values.skeOperator.affinity }}
      affinity:
        {{- . | toYaml | nindent 8 }}
      {{- end }}
      imagePullSecrets:
        - name: '{{ .Values.imageRegistry.imagePullSecret | default "syntasso-registry" }}'
{{- end }}

{{- define "containerPatch" }}
{{- with .Values.skeOperator.resources }}
resources:
  {{- . | toYaml | nindent 2 }}
{{- end }}
{{- end }}

{{- $manifest := .Files.Get "files/ske-operator-deployment.yaml" | fromYaml }}
{{- $container := index $manifest.spec.template.spec.containers 0
                    | merge (include "containerPatch" . | fromYaml) }}

{{- if and (.Values.releaseStorage) (.Values.releaseStorage.customCaCert) (.Values.releaseStorage.customCaCert.name) }}
{{- $caMountPath := "/tmp/certs/release-storage-ca" }}
{{- $caVolumeMount := dict "name" "release-storage-ca" "mountPath" $caMountPath "readOnly" true }}
{{- $_ := set $container "volumeMounts" (append ($container.volumeMounts | default (list)) $caVolumeMount) }}
{{- $caEnv := dict "name" "SSL_CERT_FILE" "value" (printf "%s/caCert" $caMountPath) }}
{{- $_ := set $container "env" (append ($container.env | default (list)) $caEnv) }}
{{- $caVolume := dict "name" "release-storage-ca" "secret" (dict "secretName" .Values.releaseStorage.customCaCert.name) }}
{{- $_ := set $manifest.spec.template.spec "volumes" (append ($manifest.spec.template.spec.volumes | default (list)) $caVolume) }}
{{- end }}

{{/* Apply image configuration from kustomization.yaml */}}
{{- $originalImage := "registry.syntasso.io/syntasso/ske-operator" }}
{{- $newName := printf "%s/%s" .Values.imageRegistry.host .Values.imageRegistry.skeOperatorImage.name }}
{{- $newTag := .Chart.AppVersion }}
{{- $_ := set $container "image" (printf "%s:%s" $newName $newTag) }}
{{- $_ := set $manifest.spec.template "spec"
              (omit $manifest.spec.template.spec "containers" "imagePullSecrets") }}

{{- $manifest
      | merge (include "patch" (merge . (dict "container" $container)) | fromYaml)
      | toYaml }}